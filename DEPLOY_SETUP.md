# Инструкция по настройке деплоя на Timeweb

## Разница между Repository secrets и Environment secrets

### Repository secrets

- Доступны для всех workflow в репозитории
- Проще в настройке
- Подходят для простых проектов

### Environment secrets

- Привязаны к конкретному environment (например, `production`, `staging`)
- Можно настроить правила защиты (требовать одобрение перед деплоем)
- Можно ограничить доступ по веткам
- Рекомендуется для production окружений

## Вариант 1: Использование Repository secrets (проще)

### Шаг 1: Настройка секретов

1. Перейдите в ваш репозиторий на GitHub
2. Откройте **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret**
4. Добавьте следующие секреты:

| Имя секрета           | Описание                                                                     | Пример значения                    |
| --------------------- | ---------------------------------------------------------------------------- | ---------------------------------- |
| `TIMEWEB_HOST`        | Адрес FTP/SFTP сервера                                                       | `ftp.myhomefab.ru` или IP-адрес    |
| `TIMEWEB_USERNAME`    | Имя пользователя FTP                                                         | `u1234567`                         |
| `TIMEWEB_PASSWORD`    | Пароль FTP                                                                   | `ваш_пароль`                       |
| `TIMEWEB_REMOTE_PATH` | Путь на сервере (с `/` или без - workflow автоматически добавит `/` в конце) | `/public_html` или `/public_html/` |

### Шаг 2: Обновление workflow (если нужно)

Если вы используете Repository secrets, убедитесь, что в `.github/workflows/deploy.yml` НЕТ строки `environment: production`. Если она есть, удалите её.

---

## Вариант 2: Использование Environment secrets (рекомендуется для production)

### Шаг 1: Создание Environment

1. Перейдите в **Settings** → **Environments**
2. Нажмите **New environment**
3. Введите имя: `production`
4. Нажмите **Configure environment**
5. (Опционально) Настройте правила защиты:
   - **Required reviewers** - можно добавить, чтобы деплой требовал одобрения
   - **Deployment branches** - можно ограничить только веткой `main`

### Шаг 2: Настройка секретов в Environment

1. В созданном environment `production` перейдите на вкладку **Secrets**
2. Нажмите **Add secret**
3. Добавьте те же секреты, что и в Варианте 1:

| Имя секрета           | Описание                                                                     | Пример значения                    |
| --------------------- | ---------------------------------------------------------------------------- | ---------------------------------- |
| `TIMEWEB_HOST`        | Адрес FTP/SFTP сервера                                                       | `ftp.myhomefab.ru` или IP-адрес    |
| `TIMEWEB_USERNAME`    | Имя пользователя FTP                                                         | `u1234567`                         |
| `TIMEWEB_PASSWORD`    | Пароль FTP                                                                   | `ваш_пароль`                       |
| `TIMEWEB_REMOTE_PATH` | Путь на сервере (с `/` или без - workflow автоматически добавит `/` в конце) | `/public_html` или `/public_html/` |

### Шаг 3: Настройка Variables (опционально)

В Environment можно также добавить **Variables** (несекретные переменные):

1. Перейдите на вкладку **Variables** в environment `production`
2. Добавьте переменные, если нужно (например, `NODE_ENV=production`)

### Шаг 4: Проверка workflow

Убедитесь, что в `.github/workflows/deploy.yml` есть строка:

```yaml
environment: production
```

---

## Как получить данные FTP в Timeweb

1. Войдите в [панель управления Timeweb](https://timeweb.com/)
2. Выберите ваш хостинг
3. Перейдите в раздел **Файлы** → **FTP-доступ**
4. Скопируйте данные:
   - **Сервер FTP**: обычно `ftp.ваш-домен.ru` или IP-адрес
   - **Логин**: обычно начинается с `u` (например, `u1234567`)
   - **Пароль**: ваш FTP-пароль
   - **Путь**: обычно `/public_html` или `/www/ваш-домен.ru/public_html`

### Альтернативный способ

Если у вас есть доступ к файловому менеджеру в панели Timeweb:

1. Откройте файловый менеджер
2. Посмотрите текущий путь - это и есть `TIMEWEB_REMOTE_PATH`
3. Обычно это `/public_html` для корня сайта

---

## Проверка настройки

После настройки секретов:

1. Сделайте commit и push в ветку `main`:

   ```bash
   git add .
   git commit -m "Настроен деплой"
   git push origin main
   ```

2. Перейдите в **Actions** в вашем репозитории на GitHub
3. Вы должны увидеть запущенный workflow "Build and Deploy to Timeweb"
4. Если всё настроено правильно, workflow завершится успешно и файлы загрузятся на сервер

---

## Устранение проблем

### Ошибка "Connection refused" или "Timeout"

- Проверьте правильность `TIMEWEB_HOST`
- Убедитесь, что FTP доступен (не заблокирован файрволом)
- Попробуйте использовать IP-адрес вместо домена

### Ошибка "Authentication failed"

- Проверьте `TIMEWEB_USERNAME` и `TIMEWEB_PASSWORD`
- Убедитесь, что нет лишних пробелов в секретах
- Проверьте, что пароль скопирован полностью

### Ошибка "Directory not found"

- Проверьте правильность `TIMEWEB_REMOTE_PATH`
- Путь должен начинаться с `/`
- Workflow автоматически добавит `/` в конце, если его нет
- Убедитесь, что директория существует на сервере

### Ошибка "server-dir should be a folder (must end with /)"

- Эта ошибка исправлена в workflow - путь автоматически нормализуется
- Убедитесь, что используете последнюю версию workflow файла

### Файлы не загружаются

- Проверьте права доступа на сервере (должны быть 755 для папок, 644 для файлов)
- Убедитесь, что `TIMEWEB_REMOTE_PATH` указывает на правильную директорию

---

## Ручной запуск деплоя

Если нужно запустить деплой вручную:

1. Перейдите в **Actions** → **Build and Deploy to Timeweb**
2. Нажмите **Run workflow**
3. Выберите ветку и нажмите **Run workflow**

---

## ⚠️ ВАЖНО: Настройка Node.js сервера для API роутов

**Проблема:** Если вы получаете ошибку 404 на `/api/admin/login`, это означает, что API роуты не работают.

**Причина:** В проекте используется `ssr: false` (SPA режим), но есть серверные API роуты (`server/api/`). Для работы API роутов **ОБЯЗАТЕЛЬНО** нужен запущенный Node.js сервер.

### Решение: Запуск Node.js сервера

Проект должен быть задеплоен не как статический сайт, а с запущенным Node.js сервером:

1. **На сервере должен быть запущен Node.js сервер:**

   ```bash
   node .output/server/index.mjs
   ```

2. **Или через PM2 (рекомендуется):**
   - Создайте файл `ecosystem.config.cjs` в корне проекта
   - Запустите: `pm2 start ecosystem.config.cjs`

3. **Где должен быть `.env` файл:**
   - В **корне проекта** (где находится `package.json` и `.output`)
   - **НЕ** в `public/` или других подпапках
   - Путь: `/корень_проекта/.env`

### Проверка структуры на сервере

После деплоя на сервере должна быть такая структура:

```
/корень_проекта/
├── .env                    ← ЗДЕСЬ должен быть файл с переменными
├── .output/
│   ├── public/             ← Статические файлы
│   └── server/
│       └── index.mjs       ← Точка входа Node.js сервера
├── package.json
└── node_modules/           ← Зависимости (если нужны)
```

### Настройка на Timeweb

Если у вас Node.js хостинг на Timeweb:

1. **Убедитесь, что Node.js включен** в панели управления
2. **Создайте `.env` файл** в корне проекта через файловый менеджер или FTP
3. **Настройте запуск сервера** через панель управления или PM2
4. **Настройте проксирование** (если нужно) - запросы к `/api/*` должны идти на Node.js сервер

### ✅ Решение для статического хостинга (БЕЗ Node.js сервера)

**Проект поддерживает работу на статическом хостинге!**

Админка (`/admin`) работает полностью на клиенте:

- **Аутентификация** - проверка пароля на клиенте
- **Хранение изображений** - в IndexedDB браузера (локально)
- **Не требует сервера** - всё работает в браузере

#### Настройка для статического хостинга:

1. **Установите пароль админки в `.env`:**

   ```env
   NUXT_PUBLIC_ADMIN_PASSWORD=gagara28
   ```

   ⚠️ **Важно:** Пароль будет виден в коде клиента (в собранном JavaScript). Это нормально для простой админки, но используйте сложный пароль.

2. **Соберите проект:**

   ```bash
   yarn build
   ```

3. **Загрузите файлы из `.output/public/`** на статический хостинг

4. **Готово!** Админка будет работать на `/admin`

#### Особенности работы на статическом хостинге:

- ✅ **Изображения хранятся локально** в IndexedDB браузера
- ✅ **Не требуют сервера** - всё работает в браузере
- ⚠️ **Данные хранятся в браузере** - при очистке данных браузера изображения удалятся
- ⚠️ **Пароль виден в коде** - используйте сложный пароль
- ⚠️ **Ограничение по размеру** - IndexedDB имеет ограничения (обычно несколько ГБ)

#### Альтернатива: Статический хостинг + внешний API сервер

Если нужна синхронизация данных между устройствами:

- Разместите клиентскую часть на статическом хостинге
- Запустите API сервер отдельно (на другом сервере или через сервис типа Vercel/Netlify Functions)
- Настройте `NUXT_PUBLIC_API_BASE` в `.env` для указания URL API сервера

---

## Настройка переменных окружения на сервере

⚠️ **КРИТИЧЕСКИ ВАЖНО:** После деплоя на сервер необходимо настроить переменные окружения, иначе админ-панель и другие функции не будут работать.

### Необходимые переменные окружения

Проект использует следующие переменные окружения (см. `nuxt.config.ts`):

| Переменная             | Описание                                   | Обязательная                 |
| ---------------------- | ------------------------------------------ | ---------------------------- |
| `ADMIN_PASSWORD`       | Пароль для доступа к админ-панели `/admin` | ✅ Да                        |
| `DB_HOST`              | Хост базы данных                           | ✅ Да (если используется БД) |
| `DB_PORT`              | Порт базы данных (по умолчанию: 3306)      | Нет                          |
| `DB_USER`              | Пользователь базы данных                   | ✅ Да (если используется БД) |
| `DB_PASSWORD`          | Пароль базы данных                         | ✅ Да (если используется БД) |
| `DB_DATABASE`          | Имя базы данных                            | ✅ Да (если используется БД) |
| `NUXT_PUBLIC_API_BASE` | Базовый URL API (опционально)              | Нет                          |

### Способ 1: Создание `.env` файла на сервере (рекомендуется)

1. Подключитесь к серверу по FTP/SFTP
2. Перейдите в корневую директорию проекта (где находится `package.json`)
3. Создайте файл `.env` (если его нет)
4. Добавьте в файл следующие строки:

```env
# Админ-панель (ОБЯЗАТЕЛЬНО!)
ADMIN_PASSWORD=ваш_пароль_админки

# База данных (если используется)
DB_HOST=localhost
DB_PORT=3306
DB_USER=ваш_пользователь_бд
DB_PASSWORD=ваш_пароль_бд
DB_DATABASE=my3d

# Публичные переменные (опционально)
NUXT_PUBLIC_API_BASE=
```

5. Сохраните файл
6. **Важно:** Убедитесь, что файл `.env` не доступен через веб-сервер (должен быть защищен)

### Способ 2: Настройка через панель хостинга (если поддерживается)

Если ваш хостинг поддерживает настройку переменных окружения через панель управления:

1. Войдите в панель управления хостингом (Timeweb)
2. Найдите раздел **Переменные окружения** или **Environment Variables**
3. Добавьте все необходимые переменные
4. Сохраните изменения
5. Перезапустите приложение (если требуется)

### Способ 3: Настройка через GitHub Actions (для CI/CD)

Если вы используете GitHub Actions для деплоя:

1. Перейдите в репозиторий на GitHub
2. Откройте **Settings** → **Secrets and variables** → **Actions**
3. Добавьте секреты:
   - `ADMIN_PASSWORD` - пароль админ-панели
   - `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_DATABASE` - данные БД (если используется)
4. Обновите workflow файл (`.github/workflows/deploy.yml`), чтобы он создавал `.env` файл на сервере после деплоя

Пример добавления в workflow:

```yaml
- name: Create .env file on server
  run: |
    echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
    echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
    # ... остальные переменные
```

### Проверка настройки

После настройки переменных окружения:

1. Попробуйте зайти на страницу `/admin`
2. Введите пароль из переменной `ADMIN_PASSWORD`
3. Если вход успешен - всё настроено правильно

### Устранение проблем

#### Не могу войти в админ-панель в проде

**Причина:** Переменная `ADMIN_PASSWORD` не настроена на сервере.

**Решение:**

1. Проверьте, что файл `.env` существует на сервере в корне проекта
2. Убедитесь, что в файле есть строка `ADMIN_PASSWORD=ваш_пароль`
3. Проверьте, что пароль совпадает с тем, что вы вводите при входе
4. Если используете Node.js хостинг, убедитесь, что переменные окружения настроены в панели
5. Перезапустите приложение после изменения переменных окружения

#### Ошибка подключения к базе данных

**Причина:** Неправильно настроены переменные БД.

**Решение:**

1. Проверьте все переменные `DB_*` в `.env` файле
2. Убедитесь, что база данных существует и доступна
3. Проверьте права доступа пользователя БД

---

## Безопасность

⚠️ **Важно:**

- Никогда не коммитьте секреты в репозиторий (файл `.env` в `.gitignore`)
- Используйте Environment secrets для production окружений
- Регулярно меняйте пароли FTP и админ-панели
- Используйте SFTP вместо FTP, если возможно (Timeweb поддерживает оба протокола)
- Убедитесь, что файл `.env` не доступен через веб-сервер (настройте `.htaccess` или аналогичный файл)
