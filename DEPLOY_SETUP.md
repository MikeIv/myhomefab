# Инструкция по настройке деплоя на Timeweb

## Разница между Repository secrets и Environment secrets

### Repository secrets
- Доступны для всех workflow в репозитории
- Проще в настройке
- Подходят для простых проектов

### Environment secrets
- Привязаны к конкретному environment (например, `production`, `staging`)
- Можно настроить правила защиты (требовать одобрение перед деплоем)
- Можно ограничить доступ по веткам
- Рекомендуется для production окружений

## Вариант 1: Использование Repository secrets (проще)

### Шаг 1: Настройка секретов

1. Перейдите в ваш репозиторий на GitHub
2. Откройте **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret**
4. Добавьте следующие секреты:

| Имя секрета | Описание | Пример значения |
|------------|----------|----------------|
| `TIMEWEB_HOST` | Адрес FTP/SFTP сервера | `ftp.myhomefab.ru` или IP-адрес |
| `TIMEWEB_USERNAME` | Имя пользователя FTP | `u1234567` |
| `TIMEWEB_PASSWORD` | Пароль FTP | `ваш_пароль` |
| `TIMEWEB_REMOTE_PATH` | Путь на сервере (с `/` или без - workflow автоматически добавит `/` в конце) | `/public_html` или `/public_html/` |

### Шаг 2: Обновление workflow (если нужно)

Если вы используете Repository secrets, убедитесь, что в `.github/workflows/deploy.yml` НЕТ строки `environment: production`. Если она есть, удалите её.

---

## Вариант 2: Использование Environment secrets (рекомендуется для production)

### Шаг 1: Создание Environment

1. Перейдите в **Settings** → **Environments**
2. Нажмите **New environment**
3. Введите имя: `production`
4. Нажмите **Configure environment**
5. (Опционально) Настройте правила защиты:
   - **Required reviewers** - можно добавить, чтобы деплой требовал одобрения
   - **Deployment branches** - можно ограничить только веткой `main`

### Шаг 2: Настройка секретов в Environment

1. В созданном environment `production` перейдите на вкладку **Secrets**
2. Нажмите **Add secret**
3. Добавьте те же секреты, что и в Варианте 1:

| Имя секрета | Описание | Пример значения |
|------------|----------|----------------|
| `TIMEWEB_HOST` | Адрес FTP/SFTP сервера | `ftp.myhomefab.ru` или IP-адрес |
| `TIMEWEB_USERNAME` | Имя пользователя FTP | `u1234567` |
| `TIMEWEB_PASSWORD` | Пароль FTP | `ваш_пароль` |
| `TIMEWEB_REMOTE_PATH` | Путь на сервере (с `/` или без - workflow автоматически добавит `/` в конце) | `/public_html` или `/public_html/` |

### Шаг 3: Настройка Variables (опционально)

В Environment можно также добавить **Variables** (несекретные переменные):

1. Перейдите на вкладку **Variables** в environment `production`
2. Добавьте переменные, если нужно (например, `NODE_ENV=production`)

### Шаг 4: Проверка workflow

Убедитесь, что в `.github/workflows/deploy.yml` есть строка:
```yaml
environment: production
```

---

## Как получить данные FTP в Timeweb

1. Войдите в [панель управления Timeweb](https://timeweb.com/)
2. Выберите ваш хостинг
3. Перейдите в раздел **Файлы** → **FTP-доступ**
4. Скопируйте данные:
   - **Сервер FTP**: обычно `ftp.ваш-домен.ru` или IP-адрес
   - **Логин**: обычно начинается с `u` (например, `u1234567`)
   - **Пароль**: ваш FTP-пароль
   - **Путь**: обычно `/public_html` или `/www/ваш-домен.ru/public_html`

### Альтернативный способ

Если у вас есть доступ к файловому менеджеру в панели Timeweb:
1. Откройте файловый менеджер
2. Посмотрите текущий путь - это и есть `TIMEWEB_REMOTE_PATH`
3. Обычно это `/public_html` для корня сайта

---

## Проверка настройки

После настройки секретов:

1. Сделайте commit и push в ветку `main`:
   ```bash
   git add .
   git commit -m "Настроен деплой"
   git push origin main
   ```

2. Перейдите в **Actions** в вашем репозитории на GitHub
3. Вы должны увидеть запущенный workflow "Build and Deploy to Timeweb"
4. Если всё настроено правильно, workflow завершится успешно и файлы загрузятся на сервер

---

## Устранение проблем

### Ошибка "Connection refused" или "Timeout"
- Проверьте правильность `TIMEWEB_HOST`
- Убедитесь, что FTP доступен (не заблокирован файрволом)
- Попробуйте использовать IP-адрес вместо домена

### Ошибка "Authentication failed"
- Проверьте `TIMEWEB_USERNAME` и `TIMEWEB_PASSWORD`
- Убедитесь, что нет лишних пробелов в секретах
- Проверьте, что пароль скопирован полностью

### Ошибка "Directory not found"
- Проверьте правильность `TIMEWEB_REMOTE_PATH`
- Путь должен начинаться с `/`
- Workflow автоматически добавит `/` в конце, если его нет
- Убедитесь, что директория существует на сервере

### Ошибка "server-dir should be a folder (must end with /)"
- Эта ошибка исправлена в workflow - путь автоматически нормализуется
- Убедитесь, что используете последнюю версию workflow файла

### Файлы не загружаются
- Проверьте права доступа на сервере (должны быть 755 для папок, 644 для файлов)
- Убедитесь, что `TIMEWEB_REMOTE_PATH` указывает на правильную директорию

---

## Ручной запуск деплоя

Если нужно запустить деплой вручную:

1. Перейдите в **Actions** → **Build and Deploy to Timeweb**
2. Нажмите **Run workflow**
3. Выберите ветку и нажмите **Run workflow**

---

## Безопасность

⚠️ **Важно:**
- Никогда не коммитьте секреты в репозиторий
- Используйте Environment secrets для production окружений
- Регулярно меняйте пароли FTP
- Используйте SFTP вместо FTP, если возможно (Timeweb поддерживает оба протокола)

