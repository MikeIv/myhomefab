#!/bin/sh

# Pre-commit hook: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–∏–Ω—Ç–µ—Ä–æ–º –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
# –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ—Ç, –∫–æ–º–º–∏—Ç –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω

echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd "$(git rev-parse --show-toplevel)" || exit 1

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ staged —Ñ–∞–π–ª–æ–≤
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue|scss|css)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ staging area."
  exit 0
fi

echo "üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
echo "$STAGED_FILES" | tr ' ' '\n' | sed 's/^/  - /'

# –ü—Ä–æ–≤–µ—Ä—è–µ–º JavaScript/TypeScript/Vue —Ñ–∞–π–ª—ã
JS_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -E '\.(js|ts|vue)$' || true)
if [ -n "$JS_FILES" ]; then
  echo ""
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint..."
  echo "$JS_FILES" | xargs npx eslint
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∏ ESLint –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    echo "–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    echo "$JS_FILES" | xargs npx eslint --fix
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ staging
    echo "$JS_FILES" | xargs git add
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    echo "$JS_FILES" | xargs npx eslint
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå –û—à–∏–±–∫–∏ ESLint –Ω–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"
      echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
      echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run lint"
      exit 1
    fi
    
    echo "‚úÖ –û—à–∏–±–∫–∏ ESLint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
  else
    echo "‚úÖ ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º CSS/SCSS —Ñ–∞–π–ª—ã
CSS_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -E '\.(css|scss)$' || true)
if [ -n "$CSS_FILES" ]; then
  echo ""
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Stylelint..."
  echo "$CSS_FILES" | xargs npx stylelint
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∏ Stylelint –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    echo "–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    echo "$CSS_FILES" | xargs npx stylelint --fix
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ staging
    echo "$CSS_FILES" | xargs git add
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    echo "$CSS_FILES" | xargs npx stylelint
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå –û—à–∏–±–∫–∏ Stylelint –Ω–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"
      echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
      echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run stylelint"
      exit 1
    fi
    
    echo "‚úÖ –û—à–∏–±–∫–∏ Stylelint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
  else
    echo "‚úÖ Stylelint –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  fi
fi

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å –ø–æ–º–æ—â—å—é Prettier
echo ""
echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é Prettier..."
echo "$STAGED_FILES" | xargs npx prettier --write

# –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ staging
echo "$STAGED_FILES" | xargs git add

# –ü—Ä–æ–≤–µ—Ä—è–µ–º TypeScript —Ñ–∞–π–ª—ã –Ω–∞ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
TS_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -E '\.(ts|vue)$' || true)
if [ -n "$TS_FILES" ]; then
  echo ""
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript –Ω–∞ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏..."
  
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º nuxi typecheck –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤
  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  TYPE_CHECK_OUTPUT=$(npx nuxi typecheck --no-emit 2>&1)
  TYPE_CHECK_EXIT_CODE=$?
  
  if [ $TYPE_CHECK_EXIT_CODE -ne 0 ]; then
    # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ –æ—à–∏–±–æ–∫
    echo "$TYPE_CHECK_OUTPUT" | head -100
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∏ TypeScript –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º."
    echo "–î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npx nuxi typecheck"
    exit 1
  else
    echo "‚úÖ TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  fi
fi

echo ""
echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
exit 0
