#!/bin/sh

# Pre-push hook: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–∏–Ω—Ç–µ—Ä–æ–º –ø–µ—Ä–µ–¥ –ø—É—à–µ–º
# –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ—Ç, –ø—É—à –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω

echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –ø—É—à–µ–º..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd "$(git rev-parse --show-toplevel)" || exit 1

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (staged –∏ unstaged)
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue|scss|css)$' || true)
UNSTAGED_FILES=$(git diff --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue|scss|css)$' || true)

# –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–ø–∏—Å–∫–∏ –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
ALL_FILES=$(echo "$CHANGED_FILES $UNSTAGED_FILES" | tr ' ' '\n' | sort -u | tr '\n' ' ')

if [ -z "$ALL_FILES" ]; then
  echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏."
  exit 0
fi

echo "üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
echo "$ALL_FILES" | tr ' ' '\n' | sed 's/^/  - /'

# –ü—Ä–æ–≤–µ—Ä—è–µ–º JavaScript/TypeScript/Vue —Ñ–∞–π–ª—ã
JS_FILES=$(echo "$ALL_FILES" | tr ' ' '\n' | grep -E '\.(js|ts|vue)$' || true)
if [ -n "$JS_FILES" ]; then
  echo ""
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint..."
  echo "$JS_FILES" | xargs npx eslint
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∏ ESLint –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    echo "–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    echo "$JS_FILES" | xargs npx eslint --fix
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    echo "$JS_FILES" | xargs npx eslint
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå –û—à–∏–±–∫–∏ ESLint –Ω–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"
      echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –ø—É—à–µ–º."
      echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run lint"
      exit 1
    fi
    
    echo "‚úÖ –û—à–∏–±–∫–∏ ESLint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
  else
    echo "‚úÖ ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º CSS/SCSS —Ñ–∞–π–ª—ã
CSS_FILES=$(echo "$ALL_FILES" | tr ' ' '\n' | grep -E '\.(css|scss)$' || true)
if [ -n "$CSS_FILES" ]; then
  echo ""
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Stylelint..."
  echo "$CSS_FILES" | xargs npx stylelint
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∏ Stylelint –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    echo "–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    echo "$CSS_FILES" | xargs npx stylelint --fix
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    echo "$CSS_FILES" | xargs npx stylelint
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå –û—à–∏–±–∫–∏ Stylelint –Ω–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"
      echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –ø—É—à–µ–º."
      echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: npm run stylelint"
      exit 1
    fi
    
    echo "‚úÖ –û—à–∏–±–∫–∏ Stylelint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
  else
    echo "‚úÖ Stylelint –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  fi
fi

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å –ø–æ–º–æ—â—å—é Prettier
echo ""
echo "üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é Prettier..."
echo "$ALL_FILES" | xargs npx prettier --write

echo ""
echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
exit 0
